#!/bin/bash
# this script gets activated via a cron to sequentially cleanup riak nodes
# when it receives a message to do so.
#
# Megam.  http://www.gomegam.com
#
# Copyright 2014, Megam systems
#

MEGAMD_HOME_DIR=/var/lib/megam/megamd
MEGAMD_HOME_DIR=$(pushd $MEGAMD_HOME_DIR > /dev/null && echo $PWD && popd > /dev/null)
MEGAMD_LOGS_DIR=$MEGAMD_HOME_DIR/logs

# here it records all the stash messages made through the interface
riakstash_file=$MEGAMD_HOME_DIR/riakstash


#test for existence of the riakstash file
if [ -f $riakstash_file ]
then
  echo "if entry" >> /var/log/megam/megamd/herk.log
  #read through the file
  while read line
  do
    echo $line >> /var/log/megam/megamd/herk.log
    curl --connect-timeout 10 -X DELETE http://localhost:8098/riak/nodes/$line
    echo $? >> /var/log/megam/megamd/herk.log
    if [ $? == 0 ]; then
      echo "*-----------------------------------------------------------------------*"  >> /var/log/upstart/herk.log
    	echo "cron herk_stash => deleted riak: $line" >> /var/log/megam/megamd/herk.log
      rm -r -f $MEGAMD_LOGS_DIR/$line
   	  echo "cron herk_stash => deleted  log: $line" >> /var/log/megam/megamd/herk.log
      echo "*-----------------------------------------------------------------------*"  >> /var/log/upstart/herk.log
    else
     	echo "cron herk_stash => delete failed : $line" >> /var/log/megam/megamd/herk.log
    fi
  done < $riakstash_file
else
  echo "$riakstash_file not found"  >> /var/log/megam/megamd/herk.log
fi
